<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrazyDesk Tracker</title>
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' app: 'unsafe-inline' 'unsafe-eval' https://*.googleapis.com https://*.firebaseio.com https://*.supabase.co https://lrdbybkovflytzygspdf.supabase.co https://firestore.googleapis.com; script-src 'self' app: 'unsafe-inline' 'unsafe-eval'; img-src 'self' app: data: blob: https://*.supabase.co https://lrdbybkovflytzygspdf.supabase.co https://*.googleusercontent.com; connect-src 'self' app: https://*.googleapis.com https://firestore.googleapis.com https://*.supabase.co; media-src 'self' data: blob: mediastream:;" />
  <style>
    :root {
      --bg: #1d232a; --bg2: #242b33; --bg3: #2a323c;
      --text: #a6adbb; --text2: #646d7a; --white: #fff;
      --primary: #6419e6; --primary-light: #7c3aed;
      --success: #22c55e; --success-bg: rgba(34,197,94,.12);
      --warning: #eab308; --warning-bg: rgba(234,179,8,.12);
      --error: #ef4444; --error-bg: rgba(239,68,68,.12);
      --info: #3b82f6; --info-bg: rgba(59,130,246,.12);
      --radius: 12px; --radius-sm: 8px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; display: flex; flex-direction: column;
      user-select: none;
    }
    button, input, textarea, select, a { -webkit-app-region: no-drag; user-select: auto; }
    .container { max-width: 420px; margin: 0 auto; padding: 16px; width: 100%; flex: 1; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; -webkit-app-region: no-drag; }
    .title-bar { padding: 8px 16px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 700; color: var(--text2); -webkit-app-region: drag; }
    .card { background: var(--bg2); border: 1px solid var(--bg3); border-radius: var(--radius); padding: 16px; }
    .card-compact { padding: 10px 14px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 18px; border-radius: var(--radius-sm); border: none;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all .15s ease; outline: none;
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-success { background: var(--success); color: var(--white); }
    .btn-success:hover:not(:disabled) { filter: brightness(1.1); }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-warning:hover:not(:disabled) { filter: brightness(1.1); }
    .btn-error { background: var(--error); color: var(--white); }
    .btn-error:hover:not(:disabled) { filter: brightness(1.1); }
    .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--bg3); }
    .btn-ghost:hover:not(:disabled) { background: var(--bg3); }
    .btn-primary { background: var(--primary); color: var(--white); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-block { width: 100%; }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .input, .textarea {
      width: 100%; padding: 10px 14px; border-radius: var(--radius-sm);
      background: var(--bg); border: 1px solid var(--bg3); color: var(--text);
      font-size: 14px; outline: none; transition: border .2s;
    }
    .input:focus, .textarea:focus { border-color: var(--primary); }
    .textarea { min-height: 100px; resize: vertical; }
    .label { font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 4px; display: block; }
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 700;
    }
    .badge-success { background: var(--success-bg); color: var(--success); }
    .badge-warning { background: var(--warning-bg); color: var(--warning); }
    .badge-error { background: var(--error-bg); color: var(--error); }
    .badge-info { background: var(--info-bg); color: var(--info); }
    .badge-ghost { background: var(--bg3); color: var(--text2); }
    .timer {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 36px; font-weight: 800; text-align: center;
      padding: 12px; letter-spacing: 2px;
    }
    .timer-sub { font-size: 11px; color: var(--text2); text-align: center; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot-success { background: var(--success); }
    .dot-warning { background: var(--warning); }
    .dot-idle { background: var(--text2); }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }
    .pulse { animation: pulse 2s infinite; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
    .stat-val { font-size: 18px; font-weight: 800; }
    .stat-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; }
    .log-entry { display: flex; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--bg3); }
    .log-entry:last-child { border-bottom: none; }
    .log-thumb { width: 48px; height: 36px; border-radius: 6px; object-fit: cover; background: var(--bg3); flex-shrink: 0; }
    .log-thumb-placeholder { width: 48px; height: 36px; border-radius: 6px; background: var(--bg3); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      display: flex; align-items: center; justify-content: center; z-index: 100; padding: 16px;
    }
    .modal-box {
      background: var(--bg2); border: 1px solid var(--bg3);
      border-radius: var(--radius); padding: 20px; width: 100%; max-width: 380px;
    }
    .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--white); }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--bg3); border-top-color: var(--primary); border-radius: 50%; animation: spin .6s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .text-center { text-align: center; }
    .text-sm { font-size: 12px; }
    .text-xs { font-size: 10px; }
    .text-muted { color: var(--text2); }
    .fw-bold { font-weight: 700; }
    .mb { margin-bottom: 8px; }
    .mt { margin-top: 8px; }
    @keyframes flash { 0% { opacity: 0; } 30% { opacity: .15; } 100% { opacity: 0; } }
    .capture-flash { position: fixed; inset: 0; background: white; pointer-events: none; animation: flash .5s ease-out; z-index: 999; }
    .toast {
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      padding: 10px 20px; border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 600; color: var(--white);
      z-index: 200; opacity: 0; transition: opacity .3s;
    }
    .toast.show { opacity: 1; }
    .toast-success { background: var(--success); }
    .toast-error { background: var(--error); }
    .toast-info { background: var(--info); }
    /* Waiting screen animation */
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    .float { animation: float 3s ease-in-out infinite; }
  </style>
</head>
<body>
  <div class="title-bar"><span>‚óè</span> CrazyDesk Tracker</div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WAITING SCREEN (no session) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="waiting-screen" class="container">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:20px;">
      <div class="float" style="font-size:64px;">üñ•Ô∏è</div>
      <h1 style="font-size:20px; font-weight:800; color:var(--white);">CrazyDesk Tracker</h1>
      <p class="text-sm text-muted text-center">Waiting for connection from your web dashboard...</p>
      <div class="spinner"></div>
      <p class="text-xs text-muted text-center" style="max-width:280px;">
        Go to your CrazyDesk web app and click <strong style="color:var(--success);">Check In</strong> to connect this app automatically.
      </p>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="app-screen" class="container hidden">
    <!-- User info -->
    <div class="card card-compact" style="display:flex; align-items:center; gap:10px; flex-direction:row;">
      <div class="dot dot-idle" id="status-dot"></div>
      <div style="flex:1;">
        <div class="fw-bold text-sm" id="user-name">User</div>
        <div class="text-xs text-muted" id="user-email">Connected via web</div>
      </div>
      <span class="badge badge-info" style="font-size:10px;">üñ•Ô∏è Desktop</span>
    </div>

    <!-- Timer -->
    <div class="card text-center">
      <div class="timer" id="timer-display">00:00:00</div>
      <div class="timer-sub" id="timer-status">Not checked in</div>
    </div>

    <!-- Tracker stats -->
    <div class="card card-compact">
      <div class="text-xs text-muted fw-bold mb">TODAY'S TRACKING</div>
      <div class="stats">
        <div><div class="stat-val" id="stat-captures">0</div><div class="stat-label">Captures</div></div>
        <div><div class="stat-val" id="stat-clicks">0</div><div class="stat-label">Clicks</div></div>
        <div><div class="stat-val" id="stat-keys">0</div><div class="stat-label">Keys</div></div>
      </div>
    </div>

    <!-- Recent logs -->
    <div class="card">
      <div class="text-xs text-muted fw-bold mb">RECENT CAPTURES</div>
      <div id="logs-list">
        <div class="text-center text-muted text-sm" style="padding:20px;">No captures yet today</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="capture-flash" class="capture-flash hidden"></div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAPTURE COUNTDOWN WARNING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="capture-countdown-modal" class="modal-overlay hidden">
    <div class="modal-box" style="max-width:340px; text-align:center;">
      <div style="font-size:48px; margin-bottom:8px;" id="countdown-icon">üì∏</div>
      <div class="modal-title" style="text-align:center;">Be Prepared!</div>
      <p class="text-sm text-muted" id="countdown-label" style="margin-bottom:16px;">
        Your screen &amp; photo will be captured in
      </p>
      <div id="countdown-timer" style="font-family:'SF Mono','Fira Code',monospace; font-size:48px; font-weight:800; color:var(--primary); margin-bottom:8px;">
        60
      </div>
      <p class="text-xs text-muted">seconds</p>
      <div id="countdown-beep-indicator" class="hidden" style="margin-top:12px;">
        <span class="badge badge-warning" style="font-size:13px; padding:6px 16px;">üîî Capturing soon...</span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP LOGIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <script type="module">
    import {
      setSession, getSession, hasSession, refreshToken,
      getActiveSession, checkIn,
      saveActivityLog, updateHeartbeat, emergencyCheckOut,
      getSessionStatus,
    } from '../modules/firebase.mjs';
    import { performCapture, startAllTracking, stopAllTracking, isCaptureInProgress } from '../modules/capture.mjs';

    const $ = id => document.getElementById(id);
    const waitingScreen = $('waiting-screen');
    const appScreen     = $('app-screen');
    const timerDisplay  = $('timer-display');
    const timerStatus   = $('timer-status');
    const statusDot     = $('status-dot');
    const userName      = $('user-name');
    const userEmail     = $('user-email');
    const logsList      = $('logs-list');
    const toastEl       = $('toast');
    const flashEl       = $('capture-flash');
    const countdownModal = $('capture-countdown-modal');
    const countdownTimer = $('countdown-timer');
    const countdownIcon  = $('countdown-icon');
    const countdownLabel = $('countdown-label');
    const countdownBeep  = $('countdown-beep-indicator');

    // ‚îÄ‚îÄ‚îÄ Capture Countdown Warning Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('show-capture-countdown', (e) => {
      const { type, seconds } = e.detail;
      const labels = { auto: 'Auto capture', manual: 'Manual capture', remote: 'Remote capture' };
      countdownLabel.textContent = `${labels[type] || 'Capture'} ‚Äî your screen & photo will be taken in`;
      countdownTimer.textContent = seconds;
      countdownIcon.textContent = 'üì∏';
      countdownBeep.classList.add('hidden');
      countdownModal.classList.remove('hidden');
    });

    window.addEventListener('capture-countdown-tick', (e) => {
      const { remaining } = e.detail;
      countdownTimer.textContent = remaining;

      // Visual change at 3 seconds ‚Äî beep zone
      if (remaining <= 3) {
        countdownTimer.style.color = 'var(--error)';
        countdownIcon.textContent = 'üîî';
        countdownBeep.classList.remove('hidden');
      } else if (remaining <= 10) {
        countdownTimer.style.color = 'var(--warning)';
      } else {
        countdownTimer.style.color = 'var(--primary)';
      }
    });

    window.addEventListener('capture-countdown-done', () => {
      countdownModal.classList.add('hidden');
      countdownTimer.style.color = 'var(--primary)';
    });

    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let sessionId = null;
    let checkInTimeMs = null;
    let isOnBreak = false;
    let breakStartMs = null;
    let totalBreakSec = 0;
    let timerInterval = null;
    let activityClicks = 0;

    // ‚îÄ‚îÄ‚îÄ Sync session state to main process for emergency checkout ‚îÄ‚îÄ
    function syncSessionToMain() {
      if (sessionId && hasSession()) {
        const { token, uid } = getSession();
        window.electronAPI?.syncSessionState({
          token, uid, sessionId, checkInTimeMs, totalBreakSec,
        });
      } else {
        window.electronAPI?.syncSessionState(null);
      }
    }
    let activityKeys = 0;
    let activityFlushInterval = null;
    let captureCount = 0;
    let heartbeatInterval = null;

    // ‚îÄ‚îÄ‚îÄ Heartbeat ‚Äî tells browser the desktop app is alive ‚îÄ‚îÄ
    // Also polls session status to detect web-initiated checkout
    function startHeartbeat() {
      stopHeartbeat();
      // Send immediately, then every 30 seconds
      if (sessionId) updateHeartbeat(sessionId).catch(() => {});
      heartbeatInterval = setInterval(async () => {
        if (!sessionId) return;
        updateHeartbeat(sessionId).catch(() => {});
        // Poll session status ‚Äî detect if web checked out
        try {
          const status = await getSessionStatus(sessionId);
          if (status === 'completed') {
            console.log('[Heartbeat] Session completed from web ‚Äî stopping tracker');
            handleWebCheckout();
          }
        } catch (e) {
          console.warn('[Heartbeat] Session poll error:', e.message);
        }
      }, 30_000);
    }
    function stopHeartbeat() {
      if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval = null; }
    }

    // ‚îÄ‚îÄ‚îÄ Handle checkout triggered from web (polling or deep link) ‚îÄ‚îÄ
    function handleWebCheckout() {
      if (!sessionId) return;
      console.log('[Checkout] Web-initiated checkout ‚Äî stopping all tracking');
      stopAllTracking();
      stopActivity();
      stopTimer();
      stopHeartbeat();
      sessionId = null;
      checkInTimeMs = null;
      isOnBreak = false;
      breakStartMs = null;
      totalBreakSec = 0;
      captureCount = 0;
      updateUI();
      syncSessionToMain();
      showToast('Checked out from web dashboard', 'info');
      window.electronAPI?.notify('CrazyDesk', 'Session ended ‚Äî checked out from web');
    }

    // ‚îÄ‚îÄ‚îÄ Emergency checkout on app quit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.electronAPI?.onAppWillQuit(async () => {
      console.log('[App] Received app-will-quit ‚Äî doing emergency checkout');
      if (sessionId && hasSession()) {
        stopAllTracking();
        stopActivity();
        stopTimer();
        stopHeartbeat();
        await emergencyCheckOut(sessionId, checkInTimeMs, totalBreakSec);
        sessionId = null;
        checkInTimeMs = null;
      }
    });

    // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg, type = 'info') {
      toastEl.textContent = msg;
      toastEl.className = `toast toast-${type} show`;
      setTimeout(() => toastEl.classList.remove('show'), 3000);
    }

    // ‚îÄ‚îÄ‚îÄ Timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startTimer() { stopTimer(); timerInterval = setInterval(updateTimer, 1000); }
    function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
    function updateTimer() {
      if (!checkInTimeMs) { timerDisplay.textContent = '00:00:00'; return; }
      const now = Date.now();
      let curBreakSec = breakStartMs ? Math.floor((now - breakStartMs) / 1000) : 0;
      const total = Math.floor((now - checkInTimeMs) / 1000);
      const effective = Math.max(0, total - totalBreakSec - curBreakSec);
      const h = String(Math.floor(effective / 3600)).padStart(2, '0');
      const m = String(Math.floor((effective % 3600) / 60)).padStart(2, '0');
      const s = String(effective % 60).padStart(2, '0');
      timerDisplay.textContent = `${h}:${m}:${s}`;
    }

    // ‚îÄ‚îÄ‚îÄ UI State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateUI() {
      if (!hasSession()) {
        waitingScreen.classList.remove('hidden');
        appScreen.classList.add('hidden');
        return;
      }
      waitingScreen.classList.add('hidden');
      appScreen.classList.remove('hidden');
      const { displayName } = getSession();
      userName.textContent = displayName || 'User';
      userEmail.textContent = 'Connected via web dashboard';

      if (!sessionId) {
        statusDot.className = 'dot dot-idle';
        timerStatus.textContent = 'Waiting for check-in from web...';
        timerDisplay.textContent = '00:00:00';
        window.electronAPI?.updateStatus('idle');
      } else if (isOnBreak) {
        statusDot.className = 'dot dot-warning pulse';
        timerStatus.textContent = '‚òï On Break';
        window.electronAPI?.updateStatus('break');
      } else {
        statusDot.className = 'dot dot-success pulse';
        timerStatus.textContent = 'üü¢ Working ‚Äî Tracker Active';
        window.electronAPI?.updateStatus('active');
      }
    }

    function flashScreen() {
      flashEl.classList.remove('hidden');
      setTimeout(() => flashEl.classList.add('hidden'), 600);
    }

    // ‚îÄ‚îÄ‚îÄ Deep link handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.electronAPI?.onDeepLink(async ({ action, params }) => {
      console.log('[DeepLink] Received! action:', action, 'params:', Object.keys(params));
      console.log('[DeepLink] token length:', params.token?.length || 0, 'uid:', params.uid);

      if (action === 'checkin' && params.token && params.uid) {
        // Set up the session
        const name = params.name || 'User';
        console.log('[DeepLink] Setting session for:', name);
        setSession(params.token, params.uid, name);
        updateUI();
        showToast('Connected!', 'success');
        window.electronAPI?.notify('CrazyDesk', 'Connected to your web session');

        // Check for existing active session
        try {
          const existing = await getActiveSession();
          if (existing) {
            sessionId = existing._id;
            checkInTimeMs = existing.checkInTime instanceof Date
              ? existing.checkInTime.getTime()
              : new Date(existing.checkInTime).getTime();
            isOnBreak = existing.status === 'break';
            totalBreakSec = 0;
            if (existing.breaks) {
              for (const b of existing.breaks) {
                if (b.endTime) {
                  const s = b.startTime instanceof Date ? b.startTime.getTime() : new Date(b.startTime).getTime();
                  const e = b.endTime instanceof Date ? b.endTime.getTime() : new Date(b.endTime).getTime();
                  totalBreakSec += Math.floor((e - s) / 1000);
                }
              }
            }
            if (isOnBreak && existing.breaks?.length) {
              const last = existing.breaks[existing.breaks.length - 1];
              if (!last.endTime) {
                breakStartMs = last.startTime instanceof Date ? last.startTime.getTime() : new Date(last.startTime).getTime();
              }
            }
            startTimer();
            startTracking();
            updateUI();
            syncSessionToMain();
            showToast('Resumed active session', 'info');
            return;
          }
        } catch (e) {
          console.warn('Restore session:', e);
        }

        // Auto check-in
        try {
          sessionId = await checkIn();
          checkInTimeMs = Date.now();
          isOnBreak = false;
          totalBreakSec = 0;
          breakStartMs = null;
          startTimer();
          startTracking();
          updateUI();
          syncSessionToMain();
          showToast('Checked in!', 'success');
          window.electronAPI?.notify('CrazyDesk', 'Checked in ‚Äî tracking started');
        } catch (e) {
          showToast('Check-in failed: ' + e.message, 'error');
        }
      }

      if (action === 'refresh' && params.token) {
        refreshToken(params.token);
        syncSessionToMain(); // Keep main process token up to date
        console.log('[Token] Refreshed');
      }

      if (action === 'checkout') {
        console.log('[DeepLink] Checkout received from web');
        handleWebCheckout();
      }

      if (action === 'capture') {
        // Remote capture command from web ‚Äî skip if another capture is already running
        if (isCaptureInProgress()) {
          console.log('[DeepLink] Capture skipped ‚Äî another capture in progress');
          showToast('Capture already in progress', 'info');
          return;
        }
        flashScreen();
        const result = await performCapture('remote');
        if (!result.skipped) {
          captureCount++;
          $('stat-captures').textContent = captureCount;
          showToast(result.flagged ? 'Capture failed' : 'Remote capture saved', result.flagged ? 'error' : 'info');
        }
      }
    });

    // ‚îÄ‚îÄ‚îÄ Start tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startTracking() {
      startAllTracking((result) => {
        flashScreen();
        captureCount++;
        $('stat-captures').textContent = captureCount;
        if (!result.flagged) {
          const label = result.type === 'manual' ? 'Manual capture saved'
                      : result.type === 'remote' ? 'Remote capture saved'
                      : 'Auto-capture saved';
          showToast(label, 'info');
        }
      });
      startActivity();
      startHeartbeat();
    }

    // ‚îÄ‚îÄ‚îÄ Activity tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startActivity() {
      stopActivity();
      activityClicks = 0; activityKeys = 0;
      window.addEventListener('click', onActivityClick);
      window.addEventListener('keydown', onActivityKey);
      activityFlushInterval = setInterval(flushActivity, 5 * 60_000);
      setInterval(() => {
        $('stat-clicks').textContent = activityClicks;
        $('stat-keys').textContent = activityKeys;
      }, 10_000);
    }
    function stopActivity() {
      window.removeEventListener('click', onActivityClick);
      window.removeEventListener('keydown', onActivityKey);
      if (activityFlushInterval) clearInterval(activityFlushInterval);
    }
    function onActivityClick() { activityClicks++; }
    function onActivityKey() { activityKeys++; }
    async function flushActivity() {
      if (!activityClicks && !activityKeys) return;
      const { uid, displayName } = getSession();
      try {
        await saveActivityLog({
          userId: uid,
          userDisplayName: displayName,
          mouseClicks: activityClicks,
          keystrokes: activityKeys,
          lastActive: new Date().toISOString(),
        });
        activityClicks = 0; activityKeys = 0;
      } catch (e) { console.error('Activity flush:', e); }
    }

    // ‚îÄ‚îÄ‚îÄ Initial UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    updateUI();
  </script>
</body>
</html>
